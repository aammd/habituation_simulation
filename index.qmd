---
title: "Habituation simulation"
subtitle: "Simulations to measure the performance of a nonlinear model of habituation"
format: html
author: Andrew MacDonald
theme: minty
---

```{r setup, include = FALSE}
options(tidyverse.quiet = TRUE)
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", tar_simple = TRUE)
library(brms)
library(tidyverse)
library(tidybayes)
```

```{r}
library(targets)
```

## Mathematical description

This document is created to validate the following model of Flight Initiation distance:

$$
\begin{align}
\text{FID} &\sim \text{Gamma}(\alpha, \alpha/\mu) \\
\mu &\sim M \times 1000 \times \left(1 - \frac{p \times X}{d + X} \right) \\
\text{logit}(M) &= M_0 + \beta_{M, i}\\
\text{logit}(p) &= p_0 + \beta_{p, i}\\
\text{log}(d)   &= d_0 + \beta_{d, i}\\
\begin{bmatrix}  \beta_{M} \  \beta_{p} \  \beta_{d} \end{bmatrix} &\sim N\left(\begin{bmatrix} 0 \ 0 \ 0 \end{bmatrix}, \Sigma\right) \\
\Sigma &= \text{diag}(\sigma_M, \sigma_p, \sigma_d) \times \text{R} \times \text{diag}(\sigma_M, \sigma_p, \sigma_d) \\
\sigma_M &\sim \text{Exponential}(4) \\
\sigma_p &\sim \text{Exponential}(2) \\
\sigma_d &\sim \text{Exponential}(2) \\
\text{R} &\sim \text{LKJ}(2) \\
M_0 &\sim N(0.5, 0.5)\\
p_0 &\sim N(-1, 0.2)\\
d_0 &\sim N(1.5, 0.5)\\
\alpha &\sim \text{Gamma}(6.25, .25)
\end{align}
$$


Begin by plotting the model's curve:

```{r one_curve}
tar_load(one_curve)
one_curve
```

```{r one_tamia_figure}
tar_load(one_sim_plot)
one_sim_plot
```

```{r nonlin_form,  eval = FALSE}
# Formula of the model 
bf(FID ~ inv_logit(logitM) * 1000 * (1 - inv_logit(logitp)*num_obs/(exp(logd) + num_obs)),
                  logitM ~ 1 + (1 |t| tamia_id),
                  logitp ~ 1 + (1 |t| tamia_id),
                  logd ~ 1 + (1 |t| tamia_id),
                  nl = TRUE,
                  family = Gamma(link = "identity"))
```


```{r nonlin_priors, eval=FALSE}
c(prior(lkj(2), class = "cor"),
                   prior(exponential(2), class = "sd", nlpar = "logd"),
                   prior(exponential(4), class = "sd", nlpar = "logitM"),
                   prior(exponential(2), class = "sd", nlpar = "logitp"),
                   prior(normal(1.5, .5), class = "b", nlpar = "logd"),
                   prior(normal(.5,.5), class = "b", nlpar = "logitM"),
                   prior(normal(-1, .2), class = "b", nlpar = "logitp"),
                   prior(gamma(6.25, .25), class = "shape"))
```

```{r nonlin_model, eval=FALSE}
brm(nonlin_form,
    data = fake_id,
    prior = nonlin_priors,
    backend = "cmdstanr",
    file = "prior_nonlin",
    chains = 0,
    file_refit = "on_change")
```
