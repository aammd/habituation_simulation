---
title: "Habituation simulation"
subtitle: "Simulations to measure the performance of a nonlinear model of habituation"
format: html
author: Andrew MacDonald
theme: minty
bibliography: references.bib
---

## Introduction

It is important to validate our statistical models before using them to reach conclusions about ecological systems. In this paper we propose a nonlinear, hierarchical statistical model to capture how Flight Initiation Distance changes with increased exposure. In this Appendix we use simulations to validate this new model, following the suggestions of \@[@direnzo2023]. We use simulations to answer several distinct questions:

1.  **Which priors are appropriate?** in hierarchical nonlinear models, it is impossible to select appropriate priors by inspection. Instead we use prior predictive checks: we select values from the prior and use these to create fake datasets.
2.  **Does the model recover parameters with large datasets?** In models with many parameters, there is always the risk that parameters are difficult to estimate well. We fit a model with a large number of *Tamia* , each observed for many repeat observations, to validate that in this "idea" setting the model works well.
3.  **Does the model recover parameters in our dataset?** Our field dataset contains unequal numbers of observations for each chipmunk, and field constraints mean that sample size in particular treatment combinations is limited. We simulate observations, while keeping every aspect of our dataset the same (treatments, number of observations per individual, etc). If a model can recover true parameters here, we can be more confident about applying it to our real observations.
4.  **Can unbalanced categories lead to spurious effect size estimates?** Due to small sample effects, we do not have exactly equal representation in all of our treatment combinations. This is especially important in model 4, where we include sex and several aspects of individual personality in our model (see main text). Importantly, because of male chipmunk behaviour, males have fewer observations per individual than do females. We use simulations to confirm that any effects of sex or personality on our results is not caused by the structure of the data.


```{r setup, include = FALSE}
#| message: false
#| warning: false
options(tidyverse.quiet = TRUE)
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", tar_simple = TRUE)
library(brms)
library(tidyverse)
library(tidybayes)
library(targets)
```

## Mathematical description

In this Appendix we validate the following model of Flight Initiation distance:

$$
\begin{align}
\text{FID} &\sim \text{Gamma}(\alpha, \alpha/\mu) \\
\mu &= M \times 1000 \times \left(1 - \frac{p \times X}{d + X} \right) \\
\text{logit}(M) &= M_0 + \beta_{M, i}\\
\text{logit}(p) &= p_0 + \beta_{p, i}\\
\text{log}(d)   &= d_0 + \beta_{d, i}\\
\begin{bmatrix}  \beta_{M} \  \beta_{p} \  \beta_{d} \end{bmatrix} &\sim N\left(\begin{bmatrix} 0 \ 0 \ 0 \end{bmatrix}, \Sigma\right) \\
\Sigma &= \text{diag}(\sigma_M, \sigma_p, \sigma_d) \times \text{R} \times \text{diag}(\sigma_M, \sigma_p, \sigma_d) \\
\sigma_M &\sim \text{Exponential}(4) \\
\sigma_p &\sim \text{Exponential}(2) \\
\sigma_d &\sim \text{Exponential}(2) \\
\text{R} &\sim \text{LKJ}(2) \\
M_0 &\sim N(0.5, 0.5)\\
p_0 &\sim N(-1, 0.2)\\
d_0 &\sim N(1.5, 0.5)\\
\alpha &\sim \text{Gamma}(6.25, .25)
\end{align}
$$

This model is an adaptation of the classic Type II functional response, adapted to our study. It describes the FID of a chipmunk in three numbers:

* $M$, the initial flight initiation distance (proportion of 1000cm)
* $p$, the proportion of this initial FID which is lost through habituation
* $d$, the number of exposures to threat required for a chipmunk to move from $M$ to its final FID after habituation, defined as $pM$.

This is an initial version of the model, which does not contain any effect of threat treatment or any effect of personality.  

```{r one_curve}
#| layout-ncol: 2
#| fig-cap: Two examples of the function (left) and the potential observations (right) described by our model. 
tar_load(one_curve)
one_curve

tar_load(one_sim_plot)
one_sim_plot
```

## Prior predictive simulations

Simulating data from a prior is essential for defining priors that reflect knowledge about a system. Here we have chosen very general priors that cover a wide range of FID responses to threat treatment. This includes many which are biologically implausible, indicating that our prior is not too restrictive. However it excludes many cases that do not match our knowledge of the system: for example, FIDs which increase with exposure, or extremely rapid or slow habituation.

```{r}
#| fig-cap: Simulations from the prior predictive distribution for our model of FID (Flight initiation distance).

tar_load(model_prior_sim)

un_tamia <- tibble::tibble(tamia_id = "un_tamia",
               num_obs = 1:20)

un_tamia_pred <- un_tamia |> 
  tidybayes::add_predicted_draws(model_prior_sim,
                                 ndraws = 15,
                                 seed = 1234)

un_tamia_expect <- un_tamia |> 
  tidybayes::add_epred_draws(model_prior_sim,
                             ndraws = 15, 
                             seed = 1234)

un_tamia_expect |> 
  left_join(un_tamia_pred) |>
  ggplot2::ggplot(ggplot2::aes(x = num_obs, y = .prediction)) + 
  ggplot2::geom_point() + 
  ggplot2::geom_line(aes(y = .epred)) + 
  ggplot2::facet_wrap(~.draw, ncol=5) + 
  labs(x = "Number of observations", y = "FID") + 
  theme_bw()
```

We can understand hyperparameters (i.e. $\sigma_M, \sigma_p, \sigma_d$ and $R$) by simulating and asking if they represent a plausible range of between-tamia variation. Again, we try to cover a range of plausible values while allowing for extreme cases.

```{r}
tar_load(prior_simulation_manytamia)

prior_sim_df <- prior_simulation_manytamia |>
  add_rownames(var = "sim_id") |> 
  unnest(cols = simulated_data)


  
prior_sim_df |> 
  ggplot(aes(x = num_obs,
             y = epred, 
             group = tamia_id)) + 
  geom_line() + 
  facet_wrap(~draw_id, ncol = 5) + 
  # coord_cartesian(ylim = c(0, 1000)) + 
  # geom_hline(yintercept = 1000, lty = 2) +
  theme_bw()

```

## Proportion of coverage

The above simulations are each datasets which, according to our model, are plausible observations for our experiment. If the same model is fit to the data, we should recover the parameters we used to create it. We fit the model described above to `r nrow(prior_simulation_manytamia)` simulated datasets. Each simulation produced a different datset with distinct parameter values. The model is fit to each, and we report a model as 'successful' if that simulation's true parameter value is above the 2.5th percentile and below the 97.5th (ie within the 95% credible interval).

```{r}
#| layout-ncol: 2
#| fig-cap: Proportion of coverage for all parameters (left) and for all the population-level parameters (right). That is, the right-hand figure shows only the main effects, shape parameter, and hyperparameters; it excludes the individual values of M, p and d for each individual.

tar_load(coverage_manytamia)
coverage_manytamia |> 
  ggplot(aes(y = variable, x = prop_covered)) + 
  geom_point() + 
  coord_cartesian(xlim = c(0, 1))

coverage_manytamia |> 
  filter(!stringr::str_detect(variable, "r_.*")) |> 
  ggplot(aes(y = variable, x = prop_covered)) + 
  geom_point() + 
  coord_cartesian(xlim = c(0, 1))

```

## Design data

let's use the actual design data to fit the model

### Prior predictive checks

```{r}
tar_load(prior_simulation_design)

prior_simulation_design |> 
  tidyr::unnest(simulated_data) |> 
  ggplot(aes(x = num_obs, y = epred, group = tamia_id)) + 
  geom_line() + 
  facet_wrap(~draw_id, ncol = 5)
```

fit to many of these and look at posterior coverage

```{r}
tar_load(coverage_design)

coverage_design |> 
  ggplot(aes(y = variable, x = prop_covered)) + 
  geom_point() + 
  coord_cartesian(xlim = c(0, 1))


coverage_manytamia |> 
  filter(!stringr::str_detect(variable, "r_.*")) |> 
  ggplot(aes(y = variable, x = prop_covered)) + 
  geom_point() + 
  coord_cartesian(xlim = c(0, 1))


```
